<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üê¥ ÂçïËØçÂ∞èÂãáÂ£´ - Word Hero</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 'cute': ['Nunito', 'cursive'] },
                    colors: {
                        'candy-pink': '#FF6B9D', 'candy-blue': '#4ECDC4', 'candy-yellow': '#FFE66D',
                        'candy-purple': '#A855F7', 'candy-orange': '#FF9F43', 'candy-green': '#26DE81'
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes wiggle { 0%, 100% { transform: rotate(-3deg); } 50% { transform: rotate(3deg); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes scorePop { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-60px) scale(1.2); opacity: 0; } }
        @keyframes confettiFall { 0% { transform: translateY(-100vh) rotate(0deg); } 100% { transform: translateY(100vh) rotate(720deg); } }
        @keyframes brickBounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes brickHit { 0% { transform: scale(1); } 50% { transform: scale(1.2) translateY(-20px); } 100% { transform: scale(1); } }
        @keyframes horseRun { 0% { transform: translateX(0) scaleX(1); } 25% { transform: translateX(10px) scaleX(1); } 50% { transform: translateX(0) scaleX(1); } 75% { transform: translateX(-10px) scaleX(1); } 100% { transform: translateX(0) scaleX(1); } }
        @keyframes wrongShake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        .animate-brick-bounce { animation: brickBounce 1s ease-in-out infinite; }
        .animate-brick-hit { animation: brickHit 0.3s ease-out; }
        .animate-horse-run { animation: horseRun 0.5s ease-in-out infinite; }
        .animate-wrong-shake { animation: wrongShake 0.3s ease-in-out; }
        @keyframes gradient-move { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
        @keyframes sparkle-burst { 
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; } 
            100% { transform: translate(calc(-50% + cos(var(--angle)) * var(--distance)), calc(-50% + sin(var(--angle)) * var(--distance))) scale(1); opacity: 0; } 
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.3); } }
        @keyframes spin { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }
        @keyframes victory-glow { 0%, 100% { text-shadow: 0 0 20px #FFD700, 0 0 40px #FF6B9D, 0 0 60px #4ECDC4, 3px 3px 0 #FF9F43; transform: scale(1); } 50% { text-shadow: 0 0 40px #FFD700, 0 0 80px #FF6B9D, 0 0 120px #4ECDC4, 5px 5px 0 #FF9F43; transform: scale(1.1); } }
        @keyframes rainbow-text { 0% { color: #FF6B9D; } 20% { color: #FFE66D; } 40% { color: #4ECDC4; } 60% { color: #A855F7; } 80% { color: #FF9F43; } 100% { color: #FF6B9D; } }
        @keyframes firework { 0% { transform: translate(-50%, -50%) scale(0); opacity: 1; } 50% { opacity: 1; } 100% { transform: translate(-50%, -50%) scale(3); opacity: 0; } }
        @keyframes trophy-bounce { 0%, 100% { transform: translateY(0) rotate(-5deg); } 25% { transform: translateY(-30px) rotate(5deg); } 50% { transform: translateY(0) rotate(-5deg); } 75% { transform: translateY(-15px) rotate(3deg); } }
        @keyframes star-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-victory-glow { animation: victory-glow 1s ease-in-out infinite; }
        .animate-rainbow { animation: rainbow-text 2s linear infinite; }
        .animate-trophy { animation: trophy-bounce 1.5s ease-in-out infinite; }
        .fancy-chinese { font-family: 'Nunito', cursive; font-weight: 900; letter-spacing: 8px; }
        body { font-family: 'Nunito', cursive; overflow: hidden; }
        .animate-wiggle { animation: wiggle 1s ease-in-out infinite; }
        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-score-pop { animation: scorePop 0.8s ease-out forwards; }
        .progress-bar { background: linear-gradient(90deg, #FF6B9D, #4ECDC4, #FFE66D, #A855F7); background-size: 300% 100%; animation: gradient-move 2s ease infinite; }
        .cute-button { background: linear-gradient(135deg, #FF6B9D 0%, #FF9F43 100%); border-radius: 50px; box-shadow: 0 8px 0 #d4547a; transition: all 0.1s; }
        .cute-button:hover { transform: translateY(-2px); }
        .cute-button:active { transform: translateY(4px); box-shadow: 0 4px 0 #d4547a; }
        .word-bubble { background: linear-gradient(135deg, #FFE66D 0%, #FF9F43 100%); border-radius: 30px; }
        .image-card { transition: all 0.3s ease; }
        .image-card.selected { transform: scale(1.08); box-shadow: 0 0 30px rgba(78, 205, 196, 0.8); }
        .skeleton-glow { filter: drop-shadow(0 0 15px #4ECDC4) drop-shadow(0 0 30px #4ECDC4); }
    </style>
    <script src="./wordbank.js"></script>
</head>
<body class="bg-gradient-to-br from-purple-400 via-pink-300 to-blue-400 min-h-screen">
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// Use word bank from external file - getAllWords() returns flat array for backward compatibility

const ENCOURAGEMENTS = ["Â§™Ê£í‰∫ÜÔºÅüåü", "‰Ω†ÁúüÂéâÂÆ≥ÔºÅüí™", "ÂÅöÂæóÂ•ΩÔºÅüéâ", "ÁªßÁª≠Âä†Ê≤πÔºÅüöÄ", "‰Ω†ÊòØÊúÄÊ£íÁöÑÔºÅ‚≠ê", "Â•ΩËÅ™ÊòéÔºÅüß†", "Áúü‰∫Ü‰∏çËµ∑ÔºÅüëè", "Â§™ÂéâÂÆ≥‰∫ÜÔºÅüèÜ"];

// Global audio unlock state
let audioUnlocked = false;
const unlockAudio = () => {
    if (audioUnlocked) return;
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    gain.gain.value = 0;
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    osc.stop(ctx.currentTime + 0.001);
    audioUnlocked = true;
    ctx.close();
};

// Horse-themed music - Galloping rhythm and cheerful melodies
const HorseMusicPlayer = ({ play }) => {
    const audioContextRef = useRef(null);
    const isPlayingRef = useRef(false);
    
    useEffect(() => {
        if (!play) {
            isPlayingRef.current = false;
            if (audioContextRef.current) {
                audioContextRef.current.close();
                audioContextRef.current = null;
            }
            return;
        }
        
        isPlayingRef.current = true;
        audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
        const ctx = audioContextRef.current;
        
        const playNote = (freq, startTime, duration, type = 'sine', vol = 0.06) => {
            if (!isPlayingRef.current) return;
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.frequency.value = freq;
            osc.type = type;
            gain.gain.setValueAtTime(vol, startTime);
            gain.gain.setValueAtTime(vol, startTime + duration * 0.7);
            gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
            osc.start(startTime);
            osc.stop(startTime + duration);
        };
        
        // Note frequencies
        const C4=261.63, D4=293.66, E4=329.63, F4=349.23, G4=392.00, A4=440.00, B4=493.88;
        const C5=523.25, D5=587.33, E5=659.25, F5=698.46, G5=783.99;
        
        // Horse-themed melodies - galloping rhythm, cheerful tunes
        const melodies = [
            // Galloping melody - upbeat and energetic
            [[G4,0.2],[G4,0.2],[E4,0.2],[G4,0.2],[C5,0.4],[B4,0.2],[A4,0.2],[G4,0.4],
             [G4,0.2],[G4,0.2],[E4,0.2],[G4,0.2],[D5,0.4],[C5,0.2],[B4,0.2],[A4,0.4],
             [A4,0.2],[A4,0.2],[F4,0.2],[A4,0.2],[E5,0.4],[D5,0.2],[C5,0.2],[B4,0.4],
             [G4,0.2],[A4,0.2],[B4,0.2],[C5,0.2],[D5,0.4],[E5,0.4],[C5,0.8]],
            // Camptown Races style - horse racing feel
            [[C5,0.3],[C5,0.3],[A4,0.3],[C5,0.3],[E5,0.6],[E5,0.3],[D5,0.3],
             [C5,0.3],[C5,0.3],[A4,0.3],[C5,0.3],[D5,0.9],[D5,0.3],
             [C5,0.3],[C5,0.3],[A4,0.3],[C5,0.3],[E5,0.6],[E5,0.3],[D5,0.3],
             [C5,0.3],[A4,0.3],[C5,0.3],[D5,0.3],[C5,1.2]],
            // William Tell Overture style - iconic horse gallop
            [[G4,0.15],[G4,0.15],[G4,0.15],[G4,0.15],[G4,0.15],[G4,0.15],[G4,0.3],
             [G4,0.15],[G4,0.15],[G4,0.15],[G4,0.15],[G4,0.15],[G4,0.15],[B4,0.3],
             [D5,0.15],[D5,0.15],[D5,0.15],[D5,0.15],[D5,0.15],[D5,0.15],[D5,0.3],
             [B4,0.15],[B4,0.15],[G4,0.15],[G4,0.15],[D5,0.3],[B4,0.3],[G4,0.6]],
            // Happy trotting melody
            [[E4,0.25],[G4,0.25],[C5,0.5],[E5,0.25],[D5,0.25],[C5,0.5],
             [E4,0.25],[G4,0.25],[B4,0.5],[D5,0.25],[C5,0.25],[B4,0.5],
             [C5,0.25],[E5,0.25],[G5,0.5],[E5,0.25],[D5,0.25],[C5,0.5],
             [B4,0.25],[A4,0.25],[G4,0.5],[E4,0.25],[D4,0.25],[C4,0.5]]
        ];
        
        const playMelody = (melodyIndex) => {
            if (!isPlayingRef.current || !audioContextRef.current) return;
            const melody = melodies[melodyIndex % melodies.length];
            let time = ctx.currentTime + 0.1;
            melody.forEach(([freq, dur]) => {
                playNote(freq, time, dur, 'square', 0.04);
                playNote(freq * 0.5, time, dur, 'triangle', 0.02); // Bass
                time += dur;
            });
            // Schedule next melody
            const totalDuration = melody.reduce((sum, [_, dur]) => sum + dur, 0);
            setTimeout(() => {
                if (isPlayingRef.current) playMelody(melodyIndex + 1);
            }, (totalDuration + 1) * 1000);
        };
        
        playMelody(0);
        
        return () => {
            isPlayingRef.current = false;
            if (audioContextRef.current) {
                audioContextRef.current.close();
                audioContextRef.current = null;
            }
        };
    }, [play]);
    
    return null;
};

// Victory celebration sound - More exciting for kids (brick hit sound + horse neigh)
const playVictorySound = () => {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    
    // Mario-style coin/brick hit sound
    const coinSound = [
        [988, 0, 0.08], [1319, 0.08, 0.3]
    ];
    coinSound.forEach(([freq, delay, dur]) => {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = freq;
        osc.type = 'square';
        gain.gain.setValueAtTime(0.2, ctx.currentTime + delay);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + delay + dur);
        osc.start(ctx.currentTime + delay);
        osc.stop(ctx.currentTime + delay + dur);
    });
    
    // Horse neigh simulation (frequency sweep)
    const neighOsc = ctx.createOscillator();
    const neighGain = ctx.createGain();
    neighOsc.connect(neighGain);
    neighGain.connect(ctx.destination);
    neighOsc.type = 'sawtooth';
    neighOsc.frequency.setValueAtTime(400, ctx.currentTime + 0.3);
    neighOsc.frequency.linearRampToValueAtTime(800, ctx.currentTime + 0.5);
    neighOsc.frequency.linearRampToValueAtTime(600, ctx.currentTime + 0.7);
    neighOsc.frequency.linearRampToValueAtTime(900, ctx.currentTime + 0.9);
    neighOsc.frequency.linearRampToValueAtTime(500, ctx.currentTime + 1.1);
    neighGain.gain.setValueAtTime(0, ctx.currentTime + 0.3);
    neighGain.gain.linearRampToValueAtTime(0.1, ctx.currentTime + 0.4);
    neighGain.gain.linearRampToValueAtTime(0.05, ctx.currentTime + 0.7);
    neighGain.gain.linearRampToValueAtTime(0.08, ctx.currentTime + 0.9);
    neighGain.gain.linearRampToValueAtTime(0.001, ctx.currentTime + 1.2);
    neighOsc.start(ctx.currentTime + 0.3);
    neighOsc.stop(ctx.currentTime + 1.2);
    
    // Sparkle sounds
    for (let i = 0; i < 5; i++) {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = 1500 + Math.random() * 1500;
        osc.type = 'sine';
        const start = ctx.currentTime + 0.4 + i * 0.1;
        gain.gain.setValueAtTime(0.06, start);
        gain.gain.exponentialRampToValueAtTime(0.001, start + 0.15);
        osc.start(start);
        osc.stop(start + 0.15);
    }
};

// Wrong answer sound - descending tone
const playWrongSound = () => {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    
    // Descending "wah wah" sound
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.type = 'triangle';
    osc.frequency.setValueAtTime(400, ctx.currentTime);
    osc.frequency.linearRampToValueAtTime(200, ctx.currentTime + 0.3);
    gain.gain.setValueAtTime(0.15, ctx.currentTime);
    gain.gain.linearRampToValueAtTime(0.001, ctx.currentTime + 0.4);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + 0.4);
    
    // Second lower tone
    const osc2 = ctx.createOscillator();
    const gain2 = ctx.createGain();
    osc2.connect(gain2);
    gain2.connect(ctx.destination);
    osc2.type = 'triangle';
    osc2.frequency.setValueAtTime(300, ctx.currentTime + 0.2);
    osc2.frequency.linearRampToValueAtTime(150, ctx.currentTime + 0.5);
    gain2.gain.setValueAtTime(0.12, ctx.currentTime + 0.2);
    gain2.gain.linearRampToValueAtTime(0.001, ctx.currentTime + 0.6);
    osc2.start(ctx.currentTime + 0.2);
    osc2.stop(ctx.currentTime + 0.6);
};

// Text-to-speech helper
const speakWord = (word) => {
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(word);
        utterance.lang = 'en-US';
        utterance.rate = 0.8;
        utterance.pitch = 1.1;
        window.speechSynthesis.speak(utterance);
    }
};

// Word Selection Screen with Horse theme music
const WordSelectionScreen = ({ onStartGame, cameraPermissionGranted }) => {
    const [selectedUnits, setSelectedUnits] = useState([]);
    const [playMusic, setPlayMusic] = useState(true);
    const videoRef = useRef(null);
    const cameraRef = useRef(null);
    
    // Start camera when permission is granted
    useEffect(() => {
        if (!videoRef.current || !cameraPermissionGranted) return;
        
        const camera = new Camera(videoRef.current, {
            onFrame: async () => {},
            width: 1280, height: 720
        });
        cameraRef.current = camera;
        camera.start();
        
        return () => {
            if (cameraRef.current) {
                cameraRef.current.stop();
                cameraRef.current = null;
            }
        };
    }, [cameraPermissionGranted]);
    
    const toggleUnit = (semesterName, unitName) => {
        const unitKey = `${semesterName}-${unitName}`;
        setSelectedUnits(prev => 
            prev.includes(unitKey) 
                ? prev.filter(u => u !== unitKey) 
                : [...prev, unitKey]
        );
    };
    
    const getSelectedWordsCount = () => {
        let count = 0;
        selectedUnits.forEach(unitKey => {
            const [semester, unit] = unitKey.split('-');
            const words = getWordsByUnit(semester, unit);
            count += words.length;
        });
        return count;
    };
    
    const handleStartGame = () => {
        const allWords = [];
        selectedUnits.forEach(unitKey => {
            const [semester, unit] = unitKey.split('-');
            const words = getWordsByUnit(semester, unit);
            allWords.push(...words.map(w => w.word));
        });
        setPlayMusic(false);
        onStartGame(allWords);
    };
    
    return (
        <div className="min-h-screen max-h-screen overflow-y-auto p-8 relative" style={{
            backgroundImage: 'url(https://images.unsplash.com/photo-1553284965-83fd3e82fa5a?w=1920&q=80)',
            backgroundSize: 'cover',
            backgroundPosition: 'center',
            backgroundAttachment: 'fixed'
        }}>
            <video ref={videoRef} className="hidden" playsInline />
            <div className="absolute inset-0 bg-gradient-to-br from-orange-900/60 via-red-800/50 to-yellow-700/60 pointer-events-none" />
            <HorseMusicPlayer play={playMusic} />
            <div className="absolute inset-0 overflow-hidden pointer-events-none">
                {[...Array(15)].map((_, i) => (
                    <div key={i} className="absolute animate-float text-3xl" style={{ left: `${Math.random()*100}%`, top: `${Math.random()*100}%`, animationDelay: `${Math.random()*3}s`, opacity: 0.7 }}>
                        {['üê¥','üèá','‚≠ê','üé†','üåæ'][i%5]}
                    </div>
                ))}
            </div>
            <div className="max-w-7xl mx-auto relative z-10 pb-20">
                <div className="text-center mb-8">
                    <h1 className="text-5xl font-black text-white drop-shadow-lg mb-4 animate-wiggle" style={{ textShadow: '2px 2px 8px rgba(0,0,0,0.8)' }}>üê¥ ÈÄâÊã©Â≠¶‰π†ÂçïÂÖÉ üê¥</h1>
                    <p className="text-xl text-white" style={{ textShadow: '1px 1px 4px rgba(0,0,0,0.8)' }}>Â∑≤ÈÄâÊã© <span className="font-bold text-candy-yellow">{getSelectedWordsCount()}</span> ‰∏™ÂçïËØç</p>
                    <p className="text-sm text-white/90 mt-2" style={{ textShadow: '1px 1px 4px rgba(0,0,0,0.8)' }}>üëÜ ÁÇπÂáªÂçïÂÖÉÂç°ÁâáÈÄâÊã©Ë¶ÅÂ≠¶‰π†ÁöÑÂÜÖÂÆπ</p>
                </div>
                
                {/* KET Topics */}
                <div className="mb-12">
                    <h2 className="text-3xl font-black text-white text-center mb-6" style={{ textShadow: '2px 2px 6px rgba(0,0,0,0.8)' }}>üåü KET ‰∏ªÈ¢òËØçÊ±á</h2>
                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                        {[
                            { name: 'Appliances', emoji: 'üì±', label: 'ÁîµÂô®' },
                            { name: 'Clothes', emoji: 'üëï', label: 'ÊúçË£Ö' },
                            { name: 'Food', emoji: 'üçï', label: 'È£üÁâ©' },
                            { name: 'Animals', emoji: 'üê∂', label: 'Âä®Áâ©' },
                            { name: 'Sports', emoji: '‚öΩ', label: 'ËøêÂä®' },
                            { name: 'Weather', emoji: '‚òÄÔ∏è', label: 'Â§©Ê∞î' },
                            { name: 'Transport', emoji: 'üöó', label: '‰∫§ÈÄö' },
                            { name: 'Colours', emoji: 'üé®', label: 'È¢úËâ≤' },
                            { name: 'Communication', emoji: 'üí¨', label: 'ÈÄöËÆØ' },
                            { name: 'Documents', emoji: 'üìÑ', label: 'Êñá‰ª∂' },
                            { name: 'Education', emoji: 'üìö', label: 'ÊïôËÇ≤' },
                            { name: 'Entertainment', emoji: 'üé¨', label: 'Â®±‰πê' },
                            { name: 'Family', emoji: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', label: 'ÂÆ∂Â∫≠' },
                            { name: 'Health', emoji: '‚ù§Ô∏è', label: 'ÂÅ•Â∫∑' },
                            { name: 'Hobbies', emoji: 'üé®', label: 'Áà±Â•Ω' },
                            { name: 'House', emoji: 'üè†', label: 'ÊàøÂ±ã' },
                            { name: 'Measurements', emoji: 'üìè', label: 'Â∫¶Èáè' },
                            { name: 'Feelings', emoji: 'üòä', label: 'ÊÉÖÊÑü' },
                            { name: 'Buildings', emoji: 'üè¢', label: 'Âª∫Á≠ë' },
                            { name: 'Countryside', emoji: 'üåæ', label: '‰π°Êùë' },
                            { name: 'City', emoji: 'üèôÔ∏è', label: 'ÂüéÂ∏Ç' },
                            { name: 'Services', emoji: '‚ÑπÔ∏è', label: 'ÊúçÂä°' },
                            { name: 'Shopping', emoji: 'üõçÔ∏è', label: 'Ë¥≠Áâ©' },
                            { name: 'Nature', emoji: 'üå≥', label: 'Ëá™ÁÑ∂' },
                            { name: 'Time', emoji: '‚è∞', label: 'Êó∂Èó¥' },
                            { name: 'Travel', emoji: '‚úàÔ∏è', label: 'ÊóÖË°å' },
                            { name: 'Work', emoji: 'üíº', label: 'Â∑•‰Ωú' },
                            { name: 'Food Extended', emoji: 'üçΩÔ∏è', label: 'È£üÁâ©Êâ©Â±ï' },
                            { name: 'Sport Extended', emoji: 'üèÜ', label: 'ËøêÂä®Êâ©Â±ï' }
                        ].map((topic) => {
                            const unitKey = `KET-${topic.name}`;
                            const isSelected = selectedUnits.includes(unitKey);
                            const wordCount = getWordsByUnit('KET', topic.name).length;
                            return (
                                <div 
                                    key={unitKey} 
                                    onClick={() => toggleUnit('KET', topic.name)}
                                    className={`relative p-6 rounded-3xl cursor-pointer transition-all duration-300 ${
                                        isSelected 
                                            ? 'bg-gradient-to-br from-candy-green to-candy-yellow scale-105 shadow-2xl' 
                                            : 'bg-white/90 hover:bg-white hover:scale-105 shadow-lg'
                                    }`}
                                >
                                    {isSelected && <div className="absolute -top-2 -right-2 w-10 h-10 bg-candy-yellow rounded-full flex items-center justify-center shadow-lg text-xl">‚úì</div>}
                                    <div className="text-center">
                                        <div className="text-4xl mb-3">{topic.emoji}</div>
                                        <div className={`font-black text-lg mb-1 ${
                                            isSelected ? 'text-white' : 'text-gray-800'
                                        }`}>{topic.label}</div>
                                        <div className={`text-xs font-semibold mb-2 ${
                                            isSelected ? 'text-white/80' : 'text-gray-500'
                                        }`}>{topic.name}</div>
                                        <div className={`text-sm font-bold ${
                                            isSelected ? 'text-white/90' : 'text-gray-600'
                                        }`}>{wordCount} ‰∏™ÂçïËØç</div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
                
                <div className="text-center mt-8">
                    <button 
                        onClick={() => getSelectedWordsCount() > 0 && handleStartGame()} 
                        disabled={getSelectedWordsCount() === 0} 
                        className={`cute-button px-16 py-5 text-white font-black text-2xl ${
                            getSelectedWordsCount() === 0 ? 'opacity-50 cursor-not-allowed' : 'animate-pulse'
                        }`}
                    >
                        üê¥ ÂºÄÂßãÊ∏∏ÊàèÔºÅ
                    </button>
                </div>
            </div>
        </div>
    );
};

// Super Fancy Confetti for Kids!
const Confetti = ({ active }) => {
    if (!active) return null;
    const colors = ['#FF6B9D', '#4ECDC4', '#FFE66D', '#A855F7', '#FF9F43', '#26DE81', '#FF4757', '#2ED573', '#1E90FF', '#FF69B4'];
    const emojis = ['‚≠ê', 'üåü', '‚ú®', 'üí´', 'üéâ', 'üéä', 'üéà', 'üéÅ', '‚ù§Ô∏è', 'üíñ', 'üåà', 'ü¶ã', 'üéÄ', 'üç≠', 'üç¨'];
    const shapes = ['circle', 'star', 'heart', 'square', 'triangle'];
    
    const getShape = (shape, color, size) => {
        switch(shape) {
            case 'star':
                return { clipPath: 'polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)', backgroundColor: color, width: size, height: size };
            case 'heart':
                return { clipPath: 'polygon(50% 100%, 0% 35%, 25% 0%, 50% 20%, 75% 0%, 100% 35%)', backgroundColor: color, width: size, height: size };
            case 'triangle':
                return { clipPath: 'polygon(50% 0%, 0% 100%, 100% 100%)', backgroundColor: color, width: size, height: size };
            case 'circle':
                return { borderRadius: '50%', backgroundColor: color, width: size, height: size };
            default:
                return { backgroundColor: color, width: size, height: size, borderRadius: '3px' };
        }
    };
    
    return (
        <div className="fixed inset-0 z-50 pointer-events-none overflow-hidden">
            {/* Colorful confetti pieces */}
            {[...Array(80)].map((_, i) => {
                const size = 10 + Math.random() * 20;
                const shape = shapes[i % shapes.length];
                const color = colors[i % colors.length];
                return (
                    <div key={`confetti-${i}`} className="absolute" style={{ 
                        left: `${Math.random()*100}%`, 
                        top: '-30px',
                        ...getShape(shape, color, `${size}px`),
                        animation: `confettiFall ${2 + Math.random() * 2}s linear forwards`,
                        animationDelay: `${Math.random() * 0.8}s`,
                        transform: `rotate(${Math.random() * 360}deg)`,
                        boxShadow: `0 0 ${size/2}px ${color}80`
                    }} />
                );
            })}
            {/* Floating emojis */}
            {[...Array(25)].map((_, i) => (
                <div key={`emoji-${i}`} className="absolute text-4xl" style={{ 
                    left: `${Math.random()*100}%`, 
                    top: '-50px',
                    animation: `confettiFall ${3 + Math.random() * 2}s linear forwards`,
                    animationDelay: `${Math.random() * 1}s`,
                    fontSize: `${30 + Math.random() * 30}px`
                }}>
                    {emojis[i % emojis.length]}
                </div>
            ))}
            {/* Sparkle bursts from center */}
            {[...Array(20)].map((_, i) => {
                const angle = (i / 20) * 360;
                const distance = 200 + Math.random() * 300;
                return (
                    <div key={`sparkle-${i}`} className="absolute" style={{
                        left: '50%',
                        top: '50%',
                        width: '20px',
                        height: '20px',
                        backgroundColor: colors[i % colors.length],
                        borderRadius: '50%',
                        boxShadow: `0 0 20px ${colors[i % colors.length]}`,
                        animation: `sparkle-burst 1.5s ease-out forwards`,
                        animationDelay: `${i * 0.05}s`,
                        '--angle': `${angle}deg`,
                        '--distance': `${distance}px`
                    }} />
                );
            })}
            {/* Big celebration text */}
            <div className="absolute top-1/3 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center animate-bounce">
                <div className="text-8xl mb-4" style={{ animation: 'pulse 0.5s ease-in-out infinite' }}>üéâ</div>
                <div className="fancy-chinese animate-victory-glow" style={{ fontSize: '5rem', color: '#FFD700', textShadow: '0 0 20px #FFD700, 0 0 40px #FF6B9D, 0 0 60px #4ECDC4, 4px 4px 0 #FF9F43, -2px -2px 0 #fff' }}>
                    Â§™Ê£í‰∫Ü!
                </div>
            </div>
            {/* Rainbow ring effect */}
            <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-64 h-64 rounded-full" style={{
                background: 'conic-gradient(#FF6B9D, #FFE66D, #4ECDC4, #A855F7, #FF9F43, #FF6B9D)',
                animation: 'spin 2s linear infinite',
                opacity: 0.3,
                filter: 'blur(20px)'
            }} />
        </div>
    );
};

// Floating Score
const FloatingScore = ({ score, x, y }) => (
    <div className="fixed text-4xl font-black text-candy-yellow animate-score-pop z-50" style={{ left: x, top: y, textShadow: '0 0 20px rgba(255, 230, 109, 0.8), 2px 2px 0 #FF9F43' }}>+{score}</div>
);

// Ultimate Victory Confetti - More spectacular for game completion!
const VictoryConfetti = ({ active }) => {
    if (!active) return null;
    const colors = ['#FFD700', '#FF6B9D', '#4ECDC4', '#A855F7', '#FF9F43', '#26DE81', '#FF4757', '#2ED573', '#1E90FF', '#FF69B4'];
    const emojis = ['üèÜ', '‚≠ê', 'üåü', '‚ú®', 'üí´', 'üéâ', 'üéä', 'üëë', 'ü•á', 'üíé', 'üåà', 'ü¶ã', 'üéÄ', 'üç≠', 'üéÅ', '‚ù§Ô∏è', 'üíñ', 'üî•', 'üíØ'];
    
    // Play ultimate victory sound
    useEffect(() => {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        // Epic fanfare
        const notes = [
            [523.25, 0, 0.2], [659.25, 0.15, 0.2], [783.99, 0.3, 0.2], [1046.50, 0.45, 0.4],
            [783.99, 0.8, 0.15], [1046.50, 0.95, 0.15], [1318.51, 1.1, 0.5],
            [1046.50, 1.5, 0.15], [1318.51, 1.65, 0.15], [1567.98, 1.8, 0.6]
        ];
        notes.forEach(([freq, delay, dur]) => {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.frequency.value = freq;
            osc.type = 'square';
            gain.gain.setValueAtTime(0.12, ctx.currentTime + delay);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + delay + dur);
            osc.start(ctx.currentTime + delay);
            osc.stop(ctx.currentTime + delay + dur);
        });
        // Sparkle cascade
        for (let i = 0; i < 15; i++) {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.frequency.value = 2500 + Math.random() * 2000;
            osc.type = 'sine';
            const start = ctx.currentTime + 2 + i * 0.1;
            gain.gain.setValueAtTime(0.06, start);
            gain.gain.exponentialRampToValueAtTime(0.001, start + 0.15);
            osc.start(start);
            osc.stop(start + 0.15);
        }
    }, []);
    
    return (
        <div className="fixed inset-0 z-50 pointer-events-none overflow-hidden">
            {/* Multiple firework bursts */}
            {[...Array(8)].map((_, burstIdx) => {
                const burstX = 15 + (burstIdx % 4) * 25;
                const burstY = 20 + Math.floor(burstIdx / 4) * 40;
                return [...Array(12)].map((_, i) => {
                    const angle = (i / 12) * 360;
                    return (
                        <div key={`firework-${burstIdx}-${i}`} className="absolute" style={{
                            left: `${burstX}%`,
                            top: `${burstY}%`,
                            width: '15px',
                            height: '15px',
                            backgroundColor: colors[(burstIdx + i) % colors.length],
                            borderRadius: '50%',
                            boxShadow: `0 0 20px ${colors[(burstIdx + i) % colors.length]}`,
                            animation: `firework 1.5s ease-out forwards`,
                            animationDelay: `${burstIdx * 0.3}s`,
                            transform: `rotate(${angle}deg) translateY(-100px)`
                        }} />
                    );
                });
            })}
            {/* Extra confetti - double the amount */}
            {[...Array(120)].map((_, i) => {
                const size = 12 + Math.random() * 25;
                const color = colors[i % colors.length];
                return (
                    <div key={`confetti-${i}`} className="absolute" style={{ 
                        left: `${Math.random()*100}%`, 
                        top: '-40px',
                        width: `${size}px`,
                        height: `${size}px`,
                        backgroundColor: color,
                        borderRadius: i % 3 === 0 ? '50%' : i % 3 === 1 ? '0' : '50% 0 50% 0',
                        animation: `confettiFall ${2 + Math.random() * 3}s linear forwards`,
                        animationDelay: `${Math.random() * 2}s`,
                        boxShadow: `0 0 ${size}px ${color}80`
                    }} />
                );
            })}
            {/* Giant floating emojis */}
            {[...Array(40)].map((_, i) => (
                <div key={`emoji-${i}`} className="absolute" style={{ 
                    left: `${Math.random()*100}%`, 
                    top: '-80px',
                    animation: `confettiFall ${3 + Math.random() * 3}s linear forwards`,
                    animationDelay: `${Math.random() * 2.5}s`,
                    fontSize: `${40 + Math.random() * 50}px`
                }}>
                    {emojis[i % emojis.length]}
                </div>
            ))}
            {/* Rotating star rings */}
            {[...Array(3)].map((_, i) => (
                <div key={`ring-${i}`} className="absolute top-1/2 left-1/2" style={{
                    width: `${200 + i * 150}px`,
                    height: `${200 + i * 150}px`,
                    border: `4px dashed ${colors[i * 3]}`,
                    borderRadius: '50%',
                    transform: 'translate(-50%, -50%)',
                    animation: `star-spin ${3 + i}s linear infinite`,
                    animationDirection: i % 2 === 0 ? 'normal' : 'reverse',
                    opacity: 0.6
                }} />
            ))}
            {/* Giant center celebration */}
            <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center">
                <div className="animate-trophy" style={{ fontSize: '12rem' }}>üèÜ</div>
            </div>
            {/* Pulsing glow background */}
            <div className="absolute inset-0" style={{
                background: 'radial-gradient(circle at center, rgba(255, 215, 0, 0.3) 0%, transparent 70%)',
                animation: 'pulse 1s ease-in-out infinite'
            }} />
        </div>
    );
};

// Main Game Screen
const GameScreen = ({ selectedWords, onBackToMenu }) => {
    const videoRef = useRef(null);
    const canvasRef = useRef(null);
    const audioRef = useRef(null);
    const audioContextRef = useRef(null);
    const analyserRef = useRef(null);
    const bgMusicRef = useRef(null);
    const cameraRef = useRef(null);
    const poseRef = useRef(null);
    const shouldProcessRef = useRef(true);
    
    const [score, setScore] = useState(0);
    const [combo, setCombo] = useState(0);
    const [correctCount, setCorrectCount] = useState(0);
    const [wrongCount, setWrongCount] = useState(0);
    const [currentWordIndex, setCurrentWordIndex] = useState(0);
    const [userPosition, setUserPosition] = useState('center');
    const [showConfetti, setShowConfetti] = useState(false);
    const [floatingScores, setFloatingScores] = useState([]);
    const [aiMessage, setAiMessage] = useState('');
    const [apiKey, setApiKey] = useState('');
    const [showSettings, setShowSettings] = useState(false);
    const [audioData, setAudioData] = useState([]);
    const [isPlaying, setIsPlaying] = useState(false);
    const [gameWords, setGameWords] = useState([]);
    const [isGameComplete, setIsGameComplete] = useState(false);
    const [hitBrick, setHitBrick] = useState(null);
    const [wrongBrick, setWrongBrick] = useState(null);
    const [headY, setHeadY] = useState(0);
    
    const processingRef = useRef(false);
    const gameWordsRef = useRef([]);
    const currentWordIndexRef = useRef(0);
    const isGameCompleteRef = useRef(false);
    const currentImagesRef = useRef([]);
    const lastHitTimeRef = useRef(0);
    
    const [playMusic, setPlayMusic] = useState(true);
    const particlesRef = useRef([]);
    
    // Brick positions (top of screen, Mario-style)
    const BRICK_Y = 120;
    const BRICK_WIDTH = 200;
    const BRICK_HEIGHT = 100;
    const BRICK_POSITIONS = [
        { x: 160, label: 'left' },
        { x: 640, label: 'center' },
        { x: 1120, label: 'right' }
    ];
    
    // Initialize floating particles (grass, flowers for horse theme)
    useEffect(() => {
        particlesRef.current = Array.from({ length: 80 }, () => ({
            x: Math.random() * 1280,
            y: Math.random() * 720,
            size: Math.random() * 3 + 1,
            speed: Math.random() * 1 + 0.5,
            type: Math.random() > 0.7 ? 'flower' : 'grass'
        }));
    }, []);
    
    // State to hold current shuffled images for the current word
    const [currentImages, setCurrentImages] = useState([]);
    
    // Shuffle images when word changes - ensures correct answer position is randomized each time
    useEffect(() => {
        if (gameWords.length > 0 && gameWords[currentWordIndex]) {
            const word = gameWords[currentWordIndex];
            const shuffled = [...word.images].sort(() => Math.random() - 0.5);
            setCurrentImages(shuffled);
            currentImagesRef.current = shuffled;
            speakWord(word.word);
        }
    }, [currentWordIndex, gameWords]);

    useEffect(() => {
        const words = selectedWords.map(wordName => {
            const wordData = getAllWords().find(w => w.word === wordName);
            return { ...wordData };
        });
        const shuffledWords = words.sort(() => Math.random() - 0.5);
        setGameWords(shuffledWords);
        gameWordsRef.current = shuffledWords;
    }, [selectedWords]);

    // Keep refs in sync with state
    useEffect(() => {
        currentWordIndexRef.current = currentWordIndex;
    }, [currentWordIndex]);

    useEffect(() => {
        isGameCompleteRef.current = isGameComplete;
    }, [isGameComplete]);

    useEffect(() => {
        if (!videoRef.current || !canvasRef.current || gameWords.length === 0) return;
        
        shouldProcessRef.current = true;
        
        const pose = new Pose({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}` });
        pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        poseRef.current = pose;
        
        pose.onResults((results) => {
            if (!shouldProcessRef.current) return;
            drawSkeleton(results);
            detectPosition(results);
        });
        
        const camera = new Camera(videoRef.current, {
            onFrame: async () => { 
                if (!shouldProcessRef.current) return;
                await pose.send({ image: videoRef.current }); 
            },
            width: 1280, height: 720
        });
        cameraRef.current = camera;
        camera.start();
        
        return () => { 
            shouldProcessRef.current = false;
            camera.stop();
            cameraRef.current = null;
            poseRef.current = null;
        };
    }, [gameWords]);

    const drawSkeleton = (results) => {
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        canvas.width = videoRef.current.videoWidth || 1280;
        canvas.height = videoRef.current.videoHeight || 720;
        
        // Draw Horse Zodiac theme background - sunny grassland
        const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        gradient.addColorStop(0, '#87CEEB');
        gradient.addColorStop(0.3, '#B0E0E6');
        gradient.addColorStop(0.6, '#98D8C8');
        gradient.addColorStop(1, '#7CB342');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Draw sun
        ctx.fillStyle = '#FFD700';
        ctx.beginPath();
        ctx.arc(100, 80, 50, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#FFF59D';
        ctx.beginPath();
        ctx.arc(100, 80, 35, 0, Math.PI * 2);
        ctx.fill();
        
        // Draw clouds
        ctx.fillStyle = '#FFFFFF';
        [[200, 100], [500, 60], [900, 90], [1100, 70]].forEach(([cx, cy]) => {
            ctx.beginPath();
            ctx.arc(cx, cy, 30, 0, Math.PI * 2);
            ctx.arc(cx + 35, cy - 10, 25, 0, Math.PI * 2);
            ctx.arc(cx + 70, cy, 30, 0, Math.PI * 2);
            ctx.arc(cx + 35, cy + 15, 20, 0, Math.PI * 2);
            ctx.fill();
        });
        
        // Draw green grass ground
        ctx.fillStyle = '#4CAF50';
        ctx.fillRect(0, canvas.height - 100, canvas.width, 100);
        ctx.fillStyle = '#388E3C';
        for (let x = 0; x < canvas.width; x += 30) {
            ctx.beginPath();
            ctx.moveTo(x, canvas.height - 100);
            ctx.lineTo(x + 15, canvas.height - 120 - Math.random() * 20);
            ctx.lineTo(x + 30, canvas.height - 100);
            ctx.fill();
        }
        
        // Draw decorative horses in background
        const drawHorse = (x, y, scale, flip) => {
            ctx.save();
            ctx.translate(x, y);
            ctx.scale(scale * (flip ? -1 : 1), scale);
            // Horse body
            ctx.fillStyle = '#8B4513';
            ctx.beginPath();
            ctx.ellipse(0, 0, 40, 25, 0, 0, Math.PI * 2);
            ctx.fill();
            // Horse head
            ctx.beginPath();
            ctx.ellipse(45, -20, 20, 15, 0.3, 0, Math.PI * 2);
            ctx.fill();
            // Horse legs
            ctx.fillRect(-25, 20, 8, 30);
            ctx.fillRect(-5, 20, 8, 30);
            ctx.fillRect(15, 20, 8, 30);
            ctx.fillRect(30, 20, 8, 30);
            // Mane
            ctx.fillStyle = '#5D4037';
            ctx.fillRect(20, -35, 25, 10);
            // Tail
            ctx.beginPath();
            ctx.moveTo(-40, 0);
            ctx.quadraticCurveTo(-60, 10, -55, 30);
            ctx.lineWidth = 5;
            ctx.strokeStyle = '#5D4037';
            ctx.stroke();
            // Eye
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.arc(55, -22, 3, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
        };
        drawHorse(150, canvas.height - 150, 0.6, false);
        drawHorse(1100, canvas.height - 140, 0.5, true);
        
        // Draw floating particles (grass seeds, petals)
        particlesRef.current.forEach(p => {
            p.y -= p.speed;
            p.x += Math.sin(Date.now() / 1000 + p.x) * 0.3;
            if (p.y < 0) {
                p.y = canvas.height;
                p.x = Math.random() * canvas.width;
            }
            ctx.fillStyle = p.type === 'flower' ? '#FF69B4' : '#90EE90';
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            ctx.fill();
        });
        
        // Draw Mario-style bricks at top
        const images = currentImagesRef.current;
        BRICK_POSITIONS.forEach((brick, idx) => {
            const isHit = hitBrick === idx;
            const isWrong = wrongBrick === idx;
            const brickY = BRICK_Y + (isHit ? -15 : 0);
            
            // Brick shadow
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.fillRect(brick.x - BRICK_WIDTH/2 + 5, brickY - BRICK_HEIGHT/2 + 5, BRICK_WIDTH, BRICK_HEIGHT);
            
            // Main brick - golden/brown Mario style
            const brickGrad = ctx.createLinearGradient(brick.x - BRICK_WIDTH/2, brickY - BRICK_HEIGHT/2, brick.x - BRICK_WIDTH/2, brickY + BRICK_HEIGHT/2);
            brickGrad.addColorStop(0, isWrong ? '#FF6B6B' : '#FFD54F');
            brickGrad.addColorStop(0.5, isWrong ? '#E53935' : '#FFB300');
            brickGrad.addColorStop(1, isWrong ? '#C62828' : '#FF8F00');
            ctx.fillStyle = brickGrad;
            ctx.fillRect(brick.x - BRICK_WIDTH/2, brickY - BRICK_HEIGHT/2, BRICK_WIDTH, BRICK_HEIGHT);
            
            // Brick border
            ctx.strokeStyle = '#5D4037';
            ctx.lineWidth = 4;
            ctx.strokeRect(brick.x - BRICK_WIDTH/2, brickY - BRICK_HEIGHT/2, BRICK_WIDTH, BRICK_HEIGHT);
            
            // Question mark or image on brick
            if (images && images[idx]) {
                // Draw image placeholder text
                ctx.fillStyle = '#FFF';
                ctx.font = 'bold 40px Nunito';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('?', brick.x, brickY);
            }
            
            // Shine effect
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            ctx.fillRect(brick.x - BRICK_WIDTH/2 + 5, brickY - BRICK_HEIGHT/2 + 5, BRICK_WIDTH - 10, 15);
        });
        
        if (results.poseLandmarks) {
            const landmarks = results.poseLandmarks.map(lm => ({ ...lm, x: 1 - lm.x }));
            
            // Get head position for brick collision
            const nose = landmarks[0];
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];
            
            const noseX = nose.x * canvas.width;
            const noseY = nose.y * canvas.height;
            const centerX = (leftShoulder.x + rightShoulder.x) / 2 * canvas.width;
            const hipY = (leftHip.y + rightHip.y) / 2 * canvas.height;
            const bodyHeight = hipY - noseY;
            const scale = Math.max(bodyHeight / 350, 0.3); // Smaller scale
            
            setHeadY(noseY);
            
            ctx.save();
            ctx.translate(centerX, noseY + 20);
            ctx.scale(scale, scale);
            
            // Draw cute cartoon pony with rider (matching reference image style)
            
            // === CUTE PONY ===
            // Pony body - round and cute tan color
            ctx.fillStyle = '#D4A574';
            ctx.beginPath();
            ctx.ellipse(0, 60, 45, 30, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Pony spots
            ctx.fillStyle = '#C4956A';
            ctx.beginPath();
            ctx.arc(-15, 55, 8, 0, Math.PI * 2);
            ctx.arc(10, 65, 6, 0, Math.PI * 2);
            ctx.fill();
            
            // Pony head - round cute shape
            ctx.fillStyle = '#D4A574';
            ctx.beginPath();
            ctx.ellipse(40, 30, 22, 18, 0.2, 0, Math.PI * 2);
            ctx.fill();
            
            // Pony snout
            ctx.fillStyle = '#E8C9A8';
            ctx.beginPath();
            ctx.ellipse(55, 38, 10, 8, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Pony nostrils
            ctx.fillStyle = '#B08968';
            ctx.beginPath();
            ctx.arc(53, 40, 2, 0, Math.PI * 2);
            ctx.arc(58, 40, 2, 0, Math.PI * 2);
            ctx.fill();
            
            // Pony ears - cute pointy
            ctx.fillStyle = '#D4A574';
            ctx.beginPath();
            ctx.moveTo(30, 15);
            ctx.quadraticCurveTo(25, -5, 35, 10);
            ctx.fill();
            ctx.beginPath();
            ctx.moveTo(45, 12);
            ctx.quadraticCurveTo(50, -8, 55, 8);
            ctx.fill();
            // Inner ear pink
            ctx.fillStyle = '#FFB6C1';
            ctx.beginPath();
            ctx.moveTo(32, 12);
            ctx.quadraticCurveTo(30, 2, 35, 10);
            ctx.fill();
            
            // Pony mane - fluffy brown
            ctx.fillStyle = '#8B6914';
            ctx.beginPath();
            ctx.moveTo(20, 20);
            ctx.quadraticCurveTo(10, 10, 15, 25);
            ctx.quadraticCurveTo(5, 20, 12, 35);
            ctx.quadraticCurveTo(0, 30, 10, 45);
            ctx.lineTo(25, 40);
            ctx.fill();
            
            // Pony happy closed eyes (curved lines)
            ctx.strokeStyle = '#5D4037';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(35, 28, 5, 0.3, Math.PI - 0.3);
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(48, 28, 5, 0.3, Math.PI - 0.3);
            ctx.stroke();
            
            // Pony rosy cheeks
            ctx.fillStyle = '#FFB6C1';
            ctx.beginPath();
            ctx.ellipse(30, 38, 6, 4, 0, 0, Math.PI * 2);
            ctx.ellipse(52, 35, 6, 4, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Pony smile
            ctx.strokeStyle = '#5D4037';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(45, 42, 8, 0.2, Math.PI - 0.2);
            ctx.stroke();
            
            // Flower necklace on pony
            const flowerColors = ['#FF69B4', '#FFD700', '#87CEEB', '#98FB98', '#DDA0DD'];
            for (let i = 0; i < 5; i++) {
                const angle = -0.5 + i * 0.25;
                const fx = 10 + Math.cos(angle) * 35;
                const fy = 50 + Math.sin(angle) * 15;
                ctx.fillStyle = flowerColors[i];
                ctx.beginPath();
                ctx.arc(fx, fy, 5, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#FFD700';
                ctx.beginPath();
                ctx.arc(fx, fy, 2, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Pony legs - cute round
            const gallop = Math.sin(Date.now() / 150) * 5;
            ctx.fillStyle = '#D4A574';
            // Front legs
            ctx.beginPath();
            ctx.ellipse(-25, 85 + gallop, 8, 20, 0.1, 0, Math.PI * 2);
            ctx.ellipse(-10, 85 - gallop, 8, 20, -0.1, 0, Math.PI * 2);
            ctx.fill();
            // Back legs
            ctx.beginPath();
            ctx.ellipse(15, 85 + gallop, 8, 20, 0.1, 0, Math.PI * 2);
            ctx.ellipse(30, 85 - gallop, 8, 20, -0.1, 0, Math.PI * 2);
            ctx.fill();
            // Hooves
            ctx.fillStyle = '#8B6914';
            ctx.beginPath();
            ctx.ellipse(-25, 102 + gallop, 6, 4, 0, 0, Math.PI * 2);
            ctx.ellipse(-10, 102 - gallop, 6, 4, 0, 0, Math.PI * 2);
            ctx.ellipse(15, 102 + gallop, 6, 4, 0, 0, Math.PI * 2);
            ctx.ellipse(30, 102 - gallop, 6, 4, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Pony tail - wavy
            ctx.fillStyle = '#8B6914';
            ctx.beginPath();
            ctx.moveTo(-45, 55);
            ctx.quadraticCurveTo(-60 + Math.sin(Date.now()/200)*5, 60, -55, 75);
            ctx.quadraticCurveTo(-65 + Math.sin(Date.now()/200)*5, 85, -50, 95);
            ctx.quadraticCurveTo(-40, 80, -45, 65);
            ctx.fill();
            
            // === CHILD RIDER ===
            // Child body - striped shirt
            ctx.fillStyle = '#4A90D9'; // Blue overalls
            ctx.beginPath();
            ctx.ellipse(0, 25, 18, 22, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Striped shirt showing
            ctx.fillStyle = '#E74C3C';
            ctx.fillRect(-12, 5, 24, 6);
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(-12, 11, 24, 5);
            ctx.fillStyle = '#E74C3C';
            ctx.fillRect(-12, 16, 24, 5);
            
            // Child head
            ctx.fillStyle = '#FFDAB9';
            ctx.beginPath();
            ctx.arc(0, -15, 18, 0, Math.PI * 2);
            ctx.fill();
            
            // Helmet - gray with patches
            ctx.fillStyle = '#708090';
            ctx.beginPath();
            ctx.arc(0, -22, 16, Math.PI, 2 * Math.PI);
            ctx.fill();
            ctx.fillRect(-16, -22, 32, 5);
            // Helmet patches
            ctx.fillStyle = '#FFD700';
            ctx.fillRect(-8, -30, 6, 6);
            ctx.fillStyle = '#FF6B6B';
            ctx.fillRect(3, -28, 5, 5);
            
            // Child hair peeking out
            ctx.fillStyle = '#8B4513';
            ctx.beginPath();
            ctx.arc(-12, -18, 5, 0, Math.PI * 2);
            ctx.arc(12, -18, 5, 0, Math.PI * 2);
            ctx.fill();
            
            // Child happy closed eyes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(-6, -15, 4, 0.3, Math.PI - 0.3);
            ctx.stroke();
            ctx.beginPath();
            ctx.arc(6, -15, 4, 0.3, Math.PI - 0.3);
            ctx.stroke();
            
            // Child rosy cheeks
            ctx.fillStyle = '#FFB6C1';
            ctx.beginPath();
            ctx.ellipse(-12, -8, 5, 3, 0, 0, Math.PI * 2);
            ctx.ellipse(12, -8, 5, 3, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Child big smile
            ctx.fillStyle = '#FFF';
            ctx.beginPath();
            ctx.arc(0, -5, 8, 0.1, Math.PI - 0.1);
            ctx.fill();
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            ctx.arc(0, -5, 8, 0.1, Math.PI - 0.1);
            ctx.stroke();
            
            // Child arms holding pony
            ctx.fillStyle = '#FFDAB9';
            ctx.beginPath();
            ctx.ellipse(-20, 20, 6, 12, -0.8, 0, Math.PI * 2);
            ctx.ellipse(20, 20, 6, 12, 0.8, 0, Math.PI * 2);
            ctx.fill();
            
            // Child legs
            ctx.fillStyle = '#4A90D9';
            ctx.beginPath();
            ctx.ellipse(-12, 45, 7, 12, 0.2, 0, Math.PI * 2);
            ctx.ellipse(12, 45, 7, 12, -0.2, 0, Math.PI * 2);
            ctx.fill();
            // Shoes
            ctx.fillStyle = '#5D9CEC';
            ctx.beginPath();
            ctx.ellipse(-12, 56, 6, 4, 0, 0, Math.PI * 2);
            ctx.ellipse(12, 56, 6, 4, 0, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.restore();
            
            // Draw head collision indicator (top of head)
            ctx.fillStyle = 'rgba(255, 215, 0, 0.5)';
            ctx.beginPath();
            ctx.arc(noseX, noseY - 30 * scale, 20, 0, Math.PI * 2);
            ctx.fill();
        }
    };

    const detectPosition = (results) => {
        if (!results.poseLandmarks) return;
        
        const canvas = canvasRef.current;
        if (!canvas) return;
        
        const landmarks = results.poseLandmarks.map(lm => ({ ...lm, x: 1 - lm.x }));
        const nose = landmarks[0];
        const noseX = nose.x * canvas.width;
        const noseY = nose.y * canvas.height;
        
        // Determine which zone the user is in
        let position;
        if (noseX < canvas.width * 0.35) position = 'left';
        else if (noseX > canvas.width * 0.65) position = 'right';
        else position = 'center';
        setUserPosition(position);
        
        // Don't process if already processing or game complete
        if (processingRef.current || isGameCompleteRef.current || gameWordsRef.current.length === 0) {
            return;
        }
        
        // Cooldown to prevent rapid re-triggering (500ms)
        if (Date.now() - lastHitTimeRef.current < 500) return;
        
        // Check for head collision with bricks (Mario-style head bump)
        // Head needs to be near the top of screen (near brick level)
        const headTop = noseY - 50; // Approximate top of head
        
        BRICK_POSITIONS.forEach((brick, idx) => {
            const brickLeft = brick.x - BRICK_WIDTH / 2;
            const brickRight = brick.x + BRICK_WIDTH / 2;
            const brickBottom = BRICK_Y + BRICK_HEIGHT / 2;
            const brickTop = BRICK_Y - BRICK_HEIGHT / 2;
            
            // Check if head is touching this brick from below
            if (noseX >= brickLeft && noseX <= brickRight &&
                headTop <= brickBottom && headTop >= brickTop - 30) {
                // Head is touching this brick!
                lastHitTimeRef.current = Date.now();
                handleBrickHit(idx);
            }
        });
    };

    const handleBrickHit = (brickIndex) => {
        // Use refs for latest values to avoid stale closure
        if (isGameCompleteRef.current || gameWordsRef.current.length === 0 || processingRef.current) return;
        processingRef.current = true;
        
        const images = currentImagesRef.current;
        if (!images || images.length === 0) {
            processingRef.current = false;
            return;
        }
        
        const selectedImage = images[brickIndex];
        
        if (selectedImage.correct) {
            // Correct answer - brick hit animation
            setHitBrick(brickIndex);
            setTimeout(() => setHitBrick(null), 300);
            
            const comboMultiplier = Math.min(combo + 1, 5);
            const earnedScore = 100 * comboMultiplier;
            
            setScore(prev => prev + earnedScore);
            setCombo(prev => prev + 1);
            setCorrectCount(prev => prev + 1);
            
            const newScore = { id: Date.now(), score: earnedScore, x: '50%', y: '30%' };
            setFloatingScores(prev => [...prev, newScore]);
            setTimeout(() => setFloatingScores(prev => prev.filter(s => s.id !== newScore.id)), 1000);
            
            setShowConfetti(true);
            playVictorySound();
            setTimeout(() => setShowConfetti(false), 2000);
            
            generateAIMessage(earnedScore, combo + 1);
            
            // Use ref for latest value to avoid stale closure
            const currentIdx = currentWordIndexRef.current;
            const totalWords = gameWordsRef.current.length;
            
            if (currentIdx + 1 >= totalWords) {
                // This is the last word - show victory!
                console.log('Game Complete! currentIdx:', currentIdx, 'totalWords:', totalWords);
                shouldProcessRef.current = false;
                if (cameraRef.current) {
                    cameraRef.current.stop();
                    cameraRef.current = null;
                }
                if (poseRef.current) {
                    poseRef.current.close();
                    poseRef.current = null;
                }
                setTimeout(() => setIsGameComplete(true), 2000);
            } else {
                setTimeout(() => {
                    setCurrentWordIndex(prev => prev + 1);
                    processingRef.current = false;
                }, 2000);
            }
        } else {
            // Wrong answer - shake animation and sound
            setWrongBrick(brickIndex);
            setTimeout(() => setWrongBrick(null), 500);
            
            setCombo(0);
            setWrongCount(prev => prev + 1);
            playWrongSound();
            setAiMessage('ÂÜçËØï‰∏ÄÊ¨°Âì¶ÔºÅüí™');
            setTimeout(() => setAiMessage(''), 2000);
            
            // Allow retry after short delay
            setTimeout(() => {
                processingRef.current = false;
            }, 600);
        }
    };

    const generateAIMessage = async (earnedScore, currentCombo) => {
        if (apiKey) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `‰Ω†ÊòØÂÑøÁ´•ÊïôËÇ≤Ê∏∏ÊàèAI„ÄÇÂ∞èÊúãÂèãÂæó‰∫Ü${earnedScore}ÂàÜÔºåËøûÂáª${currentCombo}„ÄÇÁî®ÁÆÄÁü≠ÂèØÁà±‰∏≠ÊñáÂõûÂ§ç(‰∏çË∂ÖËøá15Â≠ó)„ÄÇ` }] }] })
                });
                const data = await response.json();
                if (data.candidates?.[0]) setAiMessage(data.candidates[0].content.parts[0].text);
            } catch { setAiMessage(ENCOURAGEMENTS[Math.floor(Math.random() * ENCOURAGEMENTS.length)]); }
        } else {
            setAiMessage(ENCOURAGEMENTS[Math.floor(Math.random() * ENCOURAGEMENTS.length)]);
        }
    };

    const handleMusicUpload = (e) => {
        const file = e.target.files[0];
        if (file && audioRef.current) {
            audioRef.current.src = URL.createObjectURL(file);
            if (!audioContextRef.current) {
                audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
                analyserRef.current = audioContextRef.current.createAnalyser();
                const source = audioContextRef.current.createMediaElementSource(audioRef.current);
                source.connect(analyserRef.current);
                analyserRef.current.connect(audioContextRef.current.destination);
                analyserRef.current.fftSize = 64;
            }
            audioRef.current.play();
            setIsPlaying(true);
        }
    };

    useEffect(() => {
        if (!isPlaying || !analyserRef.current) return;
        const update = () => {
            const arr = new Uint8Array(analyserRef.current.frequencyBinCount);
            analyserRef.current.getByteFrequencyData(arr);
            setAudioData(Array.from(arr));
            requestAnimationFrame(update);
        };
        update();
    }, [isPlaying]);

    const currentWord = gameWords[currentWordIndex];

    if (isGameComplete) {
        const accuracy = gameWords.length > 0 ? Math.round((correctCount / gameWords.length) * 100) : 0;
        return (
            <div className="min-h-screen bg-gradient-to-br from-orange-400 via-yellow-300 to-green-400 flex items-center justify-center">
                <VictoryConfetti active={true} />
                <div className="text-center bg-white/90 backdrop-blur-lg rounded-3xl p-12 shadow-2xl z-10 relative">
                    <div className="text-9xl mb-6 animate-trophy">üê¥</div>
                    <h1 className="fancy-chinese animate-victory-glow mb-4" style={{ fontSize: '4rem', color: '#FFD700', textShadow: '0 0 30px #FFD700, 0 0 60px #FF6B9D, 0 0 90px #4ECDC4, 4px 4px 0 #FF9F43' }}>
                        üéâ Êú¨ËΩÆÁªìÊùü üéâ
                    </h1>
                    <p className="text-2xl text-gray-600 mb-8 font-bold">‰Ω†ÂÆåÊàê‰∫ÜÊâÄÊúâÂçïËØçÔºÅÂ§™ÂéâÂÆ≥‰∫ÜÔºÅ</p>
                    <div className="grid grid-cols-2 gap-6 mb-6">
                        <div className="bg-gradient-to-br from-candy-pink to-candy-orange p-5 rounded-2xl transform hover:scale-105 transition-all">
                            <div className="text-4xl font-black text-white animate-pulse">{score}</div>
                            <div className="text-white/90 text-lg font-bold">‚≠ê ÊÄªÂàÜÊï∞</div>
                        </div>
                        <div className="bg-gradient-to-br from-candy-blue to-candy-green p-5 rounded-2xl transform hover:scale-105 transition-all">
                            <div className="text-4xl font-black text-white animate-pulse">{accuracy}%</div>
                            <div className="text-white/90 text-lg font-bold">üìä Ê≠£Á°ÆÁéá</div>
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-6 mb-8">
                        <div className="bg-gradient-to-br from-green-400 to-green-600 p-5 rounded-2xl transform hover:scale-105 transition-all">
                            <div className="text-4xl font-black text-white animate-pulse">{correctCount}</div>
                            <div className="text-white/90 text-lg font-bold">‚úÖ Ê≠£Á°Æ</div>
                        </div>
                        <div className="bg-gradient-to-br from-red-400 to-red-600 p-5 rounded-2xl transform hover:scale-105 transition-all">
                            <div className="text-4xl font-black text-white animate-pulse">{wrongCount}</div>
                            <div className="text-white/90 text-lg font-bold">‚ùå ÈîôËØØ</div>
                        </div>
                    </div>
                    <button onClick={onBackToMenu} className="cute-button px-12 py-5 text-white font-black text-2xl hover:scale-110 transition-all">üè† ËøîÂõû‰∏ªÈ°µ</button>
                </div>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-gradient-to-br from-blue-400 via-green-300 to-yellow-200 relative overflow-hidden">
            <HorseMusicPlayer play={playMusic} />
            <video ref={videoRef} className="hidden" playsInline />
            <audio ref={audioRef} />
            <canvas ref={canvasRef} className="absolute inset-0 w-full h-full object-cover" />
            
            <Confetti active={showConfetti} />
            {floatingScores.map(fs => <FloatingScore key={fs.id} score={fs.score} x={fs.x} y={fs.y} />)}
            
            {/* Score Panel */}
            <div className="absolute top-4 left-4 z-20">
                <div className="bg-white/90 backdrop-blur-lg rounded-3xl p-4 shadow-xl">
                    <div className="flex items-center gap-3 mb-3">
                        <span className="text-3xl">‚≠ê</span>
                        <div><div className="text-2xl font-black text-gray-800">{score}</div><div className="text-xs text-gray-500">ÂàÜÊï∞</div></div>
                    </div>
                    <div className="flex items-center gap-3 mb-3">
                        <span className="text-3xl">üî•</span>
                        <div><div className="text-xl font-bold text-candy-orange">{combo}x</div><div className="text-xs text-gray-500">ËøûÂáª</div></div>
                    </div>
                    <div className="flex items-center gap-3 mb-3">
                        <span className="text-3xl">‚úÖ</span>
                        <div><div className="text-xl font-bold text-candy-green">{correctCount}</div><div className="text-xs text-gray-500">Ê≠£Á°Æ</div></div>
                    </div>
                    <div className="flex items-center gap-3">
                        <span className="text-3xl">‚ùå</span>
                        <div><div className="text-xl font-bold text-red-500">{wrongCount}</div><div className="text-xs text-gray-500">ÈîôËØØ</div></div>
                    </div>
                </div>
            </div>
            
            {/* Control Panel */}
            <div className="absolute top-4 right-4 z-20">
                <div className="bg-white/90 backdrop-blur-lg rounded-3xl p-4 shadow-xl">
                    <div className="flex flex-col gap-3">
                        <label className="cute-button px-4 py-2 text-white font-bold text-sm cursor-pointer text-center">
                            üéµ ‰∏ä‰º†Èü≥‰πê<input type="file" accept="audio/*" onChange={handleMusicUpload} className="hidden" />
                        </label>
                        <button onClick={() => setPlayMusic(!playMusic)} className="bg-gradient-to-r from-candy-green to-candy-blue px-4 py-2 text-white font-bold text-sm rounded-full">
                            {playMusic ? 'üîá ÂÖ≥Èó≠Èü≥‰πê' : 'üîä ÂºÄÂêØÈü≥‰πê'}
                        </button>
                        <button onClick={() => setShowSettings(!showSettings)} className="bg-gradient-to-r from-candy-purple to-candy-blue px-4 py-2 text-white font-bold text-sm rounded-full">‚öôÔ∏è AI ËÆæÁΩÆ</button>
                        <button onClick={onBackToMenu} className="bg-gradient-to-r from-gray-400 to-gray-500 px-4 py-2 text-white font-bold text-sm rounded-full">üè† ËøîÂõû</button>
                    </div>
                </div>
                {showSettings && (
                    <div className="mt-4 bg-white/90 backdrop-blur-lg rounded-3xl p-4 shadow-xl">
                        <h3 className="font-bold text-gray-800 mb-2">ü§ñ Gemini API Key</h3>
                        <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder="ËæìÂÖ• API Key" className="w-full px-4 py-2 rounded-xl border-2 border-candy-pink" />
                    </div>
                )}
            </div>
            
            {/* Brick Image Labels - show what each brick represents */}
            {currentImages.length > 0 && (
                <div className="absolute top-48 left-0 right-0 flex justify-around px-16 z-20">
                    {currentImages.map((img, index) => {
                        const isHit = hitBrick === index;
                        const isWrong = wrongBrick === index;
                        return (
                            <div key={`brick-label-${currentWordIndex}-${index}`} 
                                 className={`bg-white/95 rounded-2xl p-4 shadow-2xl transition-all duration-200 ${isHit ? 'animate-brick-hit scale-110' : ''} ${isWrong ? 'animate-wrong-shake bg-red-100' : ''}`} 
                                 style={{ width: '180px' }}>
                                <img src={img.url} alt={img.label} className="w-full h-32 object-contain rounded-xl" 
                                     onError={(e) => { e.target.src = `https://via.placeholder.com/150?text=${img.label}`; }} />
                            </div>
                        );
                    })}
                </div>
            )}
            
            {/* Word Display - at bottom center */}
            {currentWord && (
                <div className="absolute bottom-24 left-1/2 transform -translate-x-1/2 z-20">
                    <div className="word-bubble px-10 py-6 text-center animate-float">
                        <div className="text-5xl font-black text-gray-800">üéØ {currentWord.word}</div>
                        <div className="text-lg text-gray-600 mt-2">Áî®Â§¥È°∂Ëß¶Á¢∞Ê≠£Á°ÆÁöÑÁ†ñÂùó!</div>
                    </div>
                </div>
            )}
            
            {/* AI Message */}
            {aiMessage && (
                <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-30">
                    <div className="bg-white/95 backdrop-blur-lg rounded-3xl px-10 py-6 shadow-2xl animate-bounce">
                        <span className="text-3xl font-black text-candy-purple">{aiMessage}</span>
                    </div>
                </div>
            )}
            
            {/* Instructions */}
            <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 z-20">
                <div className="bg-white/80 backdrop-blur-lg rounded-full px-6 py-2 shadow-lg">
                    <div className="flex items-center gap-3 text-sm">
                        <span className="text-2xl">üê¥</span>
                        <span className="text-gray-600 font-bold">Ë∑≥Ëµ∑Êù•Áî®Â§¥È°∂Á†ñÂùóÈÄâÊã©Á≠îÊ°àÔºÅ</span>
                        <span className="text-2xl">üß±</span>
                    </div>
                </div>
            </div>
            
            {/* Progress indicator */}
            <div className="absolute bottom-4 right-4 z-20">
                <div className="bg-white/80 backdrop-blur-lg rounded-full px-4 py-2 shadow-lg">
                    <span className="text-gray-700 font-bold">{currentWordIndex + 1} / {gameWords.length}</span>
                </div>
            </div>
            
            {/* Audio Visualizer */}
            {isPlaying && audioData.length > 0 && (
                <div className="absolute bottom-0 left-0 right-0 h-12 flex items-end justify-center gap-1 z-10 opacity-40">
                    {audioData.slice(0, 32).map((v, i) => (
                        <div key={i} className="w-2 bg-gradient-to-t from-candy-pink to-candy-yellow rounded-t" style={{ height: `${v / 4}px` }} />
                    ))}
                </div>
            )}
        </div>
    );
};

// Camera Permission Screen
const CameraPermissionScreen = ({ onAllow, onDeny }) => {
    return (
        <div className="fixed inset-0 flex items-center justify-center z-50" style={{
            backgroundImage: 'url(https://images.unsplash.com/photo-1553284965-83fd3e82fa5a?w=1920&q=80)',
            backgroundSize: 'cover',
            backgroundPosition: 'center'
        }}>
            <div className="absolute inset-0 bg-gradient-to-br from-orange-900/60 via-yellow-700/50 to-green-600/60" />
            <div className="absolute inset-0 overflow-hidden pointer-events-none">
                {[...Array(15)].map((_, i) => (
                    <div key={i} className="absolute animate-float text-3xl" style={{ left: `${Math.random()*100}%`, top: `${Math.random()*100}%`, animationDelay: `${Math.random()*3}s`, opacity: 0.7 }}>
                        {['üê¥','üèá','‚≠ê','üåæ','üé†'][i%5]}
                    </div>
                ))}
            </div>
            <div className="bg-white rounded-3xl p-10 shadow-2xl max-w-lg mx-4 text-center relative z-10">
                <div className="text-8xl mb-6 animate-bounce">üì∏</div>
                <h2 className="text-4xl font-black text-gray-800 mb-4">ÈúÄË¶Å‰ΩøÁî®ÊëÑÂÉèÂ§¥</h2>
                <p className="text-xl text-gray-600 mb-3">
                    Ê∏∏ÊàèÈúÄË¶Å‰ΩøÁî®ÊëÑÂÉèÂ§¥Êù•ËØÜÂà´‰Ω†ÁöÑÂä®‰Ωú
                </p>
                <p className="text-lg text-gray-500 mb-8">
                    ËØ∑ÂÖÅËÆ∏ËÆøÈóÆÊëÑÂÉèÂ§¥‰ª•ÁªßÁª≠Ê∏∏Êàè üê¥
                </p>
                <div className="flex gap-4 justify-center">
                    <button 
                        onClick={onAllow}
                        className="cute-button px-10 py-5 text-white font-black text-2xl animate-pulse"
                    >
                        ‚úÖ ÂÖÅËÆ∏‰ΩøÁî®
                    </button>
                    <button 
                        onClick={onDeny}
                        className="bg-gray-400 px-10 py-5 text-white font-black text-2xl rounded-full shadow-lg hover:bg-gray-500 transition-all"
                        style={{ boxShadow: '0 8px 0 #9ca3af' }}
                    >
                        ‚ùå ÂèñÊ∂à
                    </button>
                </div>
            </div>
        </div>
    );
};

// Welcome Screen - Click to start (unlocks audio)
const WelcomeScreen = ({ onStart }) => {
    const handleClick = () => {
        unlockAudio();
        onStart();
    };
    
    return (
        <div onClick={handleClick} className="fixed inset-0 cursor-pointer flex flex-col items-center justify-center z-50" style={{
            backgroundImage: 'url(https://images.unsplash.com/photo-1553284965-83fd3e82fa5a?w=1920&q=80)',
            backgroundSize: 'cover',
            backgroundPosition: 'center'
        }}>
            <div className="absolute inset-0 bg-gradient-to-br from-orange-900/50 via-yellow-600/40 to-green-700/50" />
            <div className="text-center z-10">
                <div className="text-9xl mb-8 animate-bounce">üê¥</div>
                <h1 className="text-6xl font-black text-white mb-6" style={{ textShadow: '3px 3px 10px rgba(0,0,0,0.8)' }}>
                    üèá ÂçïËØçÂ∞èÂãáÂ£´ üèá
                </h1>
                <p className="text-3xl text-white mb-4" style={{ textShadow: '2px 2px 6px rgba(0,0,0,0.8)' }}>
                    Horse Year Word Hero
                </p>
                <p className="text-xl text-yellow-200 mb-8" style={{ textShadow: '1px 1px 4px rgba(0,0,0,0.8)' }}>
                    üß± Áî®Â§¥È°∂Á†ñÂùóÂ≠¶ÂçïËØç - È©¨ÈáåÂ••È£éÊ†º‰∫íÂä® üß±
                </p>
                <div className="bg-white/90 backdrop-blur-lg rounded-full px-12 py-6 shadow-2xl animate-pulse">
                    <span className="text-3xl font-black text-candy-pink">üëÜ ÁÇπÂáªÂ±èÂπïÂºÄÂßã üëÜ</span>
                </div>
                <p className="text-xl text-white/80 mt-6" style={{ textShadow: '1px 1px 4px rgba(0,0,0,0.8)' }}>
                    üîä ÁÇπÂáªÂêéÂ∞ÜÊí≠ÊîæÈ©¨Âπ¥‰∏ªÈ¢òÈü≥‰πê
                </p>
            </div>
            <div className="absolute bottom-10 flex gap-8">
                {['üê¥','üèá','üé†','‚≠ê','üåæ','üêé'].map((e, i) => (
                    <span key={i} className="text-6xl animate-bounce" style={{ animationDelay: `${i*0.15}s` }}>{e}</span>
                ))}
            </div>
        </div>
    );
};

// Main App
const App = () => {
    const [screen, setScreen] = useState('welcome');
    const [selectedWords, setSelectedWords] = useState([]);
    const [cameraPermissionGranted, setCameraPermissionGranted] = useState(false);

    const handleStartGame = (words) => { setSelectedWords(words); setScreen('game'); };
    const handleBackToMenu = () => { setScreen('selection'); setSelectedWords([]); };
    const handleCameraAllow = () => { 
        setCameraPermissionGranted(true);
        setScreen('selection'); 
    };
    const handleCameraDeny = () => { setScreen('welcome'); };

    if (screen === 'welcome') return <WelcomeScreen onStart={() => setScreen('camera')} />;
    if (screen === 'camera') return <CameraPermissionScreen onAllow={handleCameraAllow} onDeny={handleCameraDeny} />;
    if (screen === 'selection') return <WordSelectionScreen onStartGame={handleStartGame} cameraPermissionGranted={cameraPermissionGranted} />;
    if (screen === 'game') return <GameScreen selectedWords={selectedWords} onBackToMenu={handleBackToMenu} />;
    return null;
};

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
